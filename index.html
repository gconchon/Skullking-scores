<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <title>Skull King ‚Äî Scores</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React via CDN + Babel for JSX in the browser -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { -webkit-tap-highlight-color: transparent; }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="app" class="min-h-screen"></div>

  <script type="text/babel">
    const { useState, useMemo } = React;

    function clamp(n, min, max) { return Math.min(max, Math.max(min, n)); }

    function SkullKingScoreApp() {
      const [playerCount, setPlayerCount] = useState(4);
      const [players, setPlayers] = useState([]);
      const [round, setRound] = useState(1);
      const [scores, setScores] = useState([]);
      const [showSettings, setShowSettings] = useState(false);
      const [settings, setSettings] = useState({ pirateBonus: 30 });
      const maxRounds = useMemo(() => 10, []);

      const initPlayers = () => {
        const initialPlayers = Array.from({ length: clamp(playerCount, 2, 8) }, (_, i) => ({
          name: localStorage.getItem("sk_player_" + i) || \`Joueur \${i + 1}\`,
          total: 0,
        }));
        setPlayers(initialPlayers);
        setScores([]);
        setRound(1);
      };

      const basePoints = (bid, tricks, r) => {
        if (Number.isNaN(bid) || Number.isNaN(tricks)) return 0;
        if (bid === 0) return tricks === 0 ? 10 * r : -10 * r;
        return tricks === bid ? 20 * bid : -10 * Math.abs(bid - tricks);
      };

      const addRoundScores = (roundData) => {
        const newScores = [...scores, roundData];
        const updatedPlayers = players.map((p, i) => ({ ...p, total: p.total + roundData[i] }));
        setScores(newScores);
        setPlayers(updatedPlayers);
        setRound(round + 1);
        // save progress
        localStorage.setItem("sk_scores", JSON.stringify(newScores));
        localStorage.setItem("sk_players", JSON.stringify(updatedPlayers));
        localStorage.setItem("sk_round", String(round + 1));
        localStorage.setItem("sk_settings", JSON.stringify(settings));
      };

      React.useEffect(() => {
        try {
          const savedPlayers = JSON.parse(localStorage.getItem("sk_players") || "null");
          const savedScores = JSON.parse(localStorage.getItem("sk_scores") || "null");
          const savedRound = parseInt(localStorage.getItem("sk_round") || "1");
          const savedSettings = JSON.parse(localStorage.getItem("sk_settings") || "null");
          if (savedPlayers && Array.isArray(savedPlayers)) setPlayers(savedPlayers);
          if (savedScores && Array.isArray(savedScores)) setScores(savedScores);
          if (!Number.isNaN(savedRound)) setRound(savedRound);
          if (savedSettings) setSettings(savedSettings);
        } catch (e) {}
      }, []);

      const handleRoundSubmit = (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const roundScores = players.map((_, i) => {
          const bid = parseInt(formData.get(\`bid-\${i}\`));
          const tricks = parseInt(formData.get(\`tricks-\${i}\`));
          const pirates = parseInt(formData.get(\`pirates-\${i}\`));
          const custom = parseInt(formData.get(\`custom-\${i}\`));
          const base = basePoints(bid, tricks, round);
          const piratePts = (Number.isNaN(pirates) ? 0 : pirates) * settings.pirateBonus;
          const customPts = Number.isNaN(custom) ? 0 : custom;
          return base + piratePts + customPts;
        });
        addRoundScores(roundScores);
        e.target.reset();
      };

      const updatePlayerName = (idx, name) => {
        setPlayers((prev) => prev.map((p, i) => (i === idx ? { ...p, name } : p)));
        localStorage.setItem("sk_player_" + idx, name);
        localStorage.setItem("sk_players", JSON.stringify(players.map((p, i) => i === idx ? { ...p, name } : p)));
      };

      const resetGame = () => {
        if (!confirm("R√©initialiser la partie ?")) return;
        setScores([]);
        setRound(1);
        setPlayers(players.map(p => ({ ...p, total: 0 })));
        localStorage.removeItem("sk_scores");
        localStorage.setItem("sk_round", "1");
      };

      return (
        <div className="p-4 max-w-6xl mx-auto">
          <header className="flex items-center justify-between mb-4">
            <h1 className="text-2xl font-bold">Skull King ‚Äî Scores</h1>
            <button onClick={resetGame} className="text-sm px-3 py-1 border rounded">R√©initialiser</button>
          </header>

          {!players.length && (
            <div className="mb-6 space-y-3">
              <div>
                <label className="block mb-1 font-medium">Nombre de joueurs (2‚Äì8)</label>
                <input
                  type="number"
                  min={2}
                  max={8}
                  value={playerCount}
                  onChange={(e) => setPlayerCount(parseInt(e.target.value))}
                  className="border p-2 rounded w-32"
                  inputMode="numeric"
                />
              </div>
              <button onClick={initPlayers} className="bg-blue-600 text-white px-4 py-2 rounded w-full sm:w-auto">
                D√©marrer la partie
              </button>
              <p className="text-xs text-gray-600">Astuce : tu peux enregistrer les noms apr√®s avoir d√©marr√©.</p>
            </div>
          )}

          {players.length > 0 && (
            <>
              <button className="text-sm underline mb-3" onClick={() => setShowSettings(s => !s)}>
                {showSettings ? "Masquer les param√®tres" : "Afficher/√©diter les param√®tres de bonus"}
              </button>

              {showSettings && (
                <div className="border rounded p-3 mb-4 grid sm:grid-cols-2 gap-4 bg-white">
                  <div>
                    <label className="block text-sm font-medium mb-1">Bonus par pirate captur√©</label>
                    <input
                      type="number"
                      value={settings.pirateBonus}
                      onChange={(e) => {
                        const v = parseInt(e.target.value || "0");
                        const ns = { ...settings, pirateBonus: v };
                        setSettings(ns);
                        localStorage.setItem("sk_settings", JSON.stringify(ns));
                      }}
                      className="border p-2 rounded w-40"
                      inputMode="numeric"
                    />
                    <p className="text-xs text-gray-600 mt-1">Adapte selon ta variante (ex : 30).</p>
                  </div>
                </div>
              )}

              <div className="mb-4 grid md:grid-cols-4 sm:grid-cols-2 grid-cols-1 gap-3">
                {players.map((p, i) => (
                  <div key={i} className="border rounded p-2 bg-white">
                    <label className="block text-xs text-gray-600">Nom du joueur</label>
                    <input
                      value={p.name}
                      onChange={(e) => updatePlayerName(i, e.target.value)}
                      className="border p-2 rounded w-full"
                    />
                  </div>
                ))}
              </div>

              <div className="overflow-x-auto">
                <table className="w-full border mb-4 text-sm bg-white">
                  <thead>
                    <tr className="bg-gray-100">
                      <th className="border px-2 py-1 text-left">Manche</th>
                      {players.map((p, i) => (
                        <th key={i} className="border px-2 py-1 text-left">{p.name}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {scores.map((roundData, r) => (
                      <tr key={r}>
                        <td className="border px-2 py-1">{r + 1}</td>
                        {roundData.map((score, i) => (
                          <td key={i} className="border px-2 py-1">{score}</td>
                        ))}
                      </tr>
                    ))}
                    <tr className="font-semibold">
                      <td className="border px-2 py-1">Total</td>
                      {players.map((p, i) => (
                        <td key={i} className="border px-2 py-1">{p.total}</td>
                      ))}
                    </tr>
                  </tbody>
                </table>
              </div>

              {round <= maxRounds ? (
                <form onSubmit={handleRoundSubmit} className="mb-6">
                  <h2 className="text-xl font-semibold mb-2">Manche {round}</h2>
                  <div className="grid lg:grid-cols-3 md:grid-cols-2 grid-cols-1 gap-4">
                    {players.map((p, i) => (
                      <div key={i} className="border p-3 rounded bg-white">
                        <div className="font-semibold mb-2">{p.name}</div>

                        <label className="block text-xs">Pari</label>
                        <input type="number" name={"bid-" + i} min={0} className="border p-2 rounded w-full mb-2" required inputMode="numeric" />

                        <label className="block text-xs">Plis gagn√©s</label>
                        <input type="number" name={"tricks-" + i} min={0} className="border p-2 rounded w-full mb-2" required inputMode="numeric" />

                        <div className="mt-2 border-t pt-2">
                          <div className="text-sm font-medium mb-1">Pirates captur√©s</div>
                          <div className="text-xs text-gray-600 mb-1">x {settings.pirateBonus} pts chacun</div>
                          <input type="number" name={"pirates-" + i} min={0} className="border p-2 rounded w-full" defaultValue={0} inputMode="numeric" />
                        </div>

                        <div className="mt-2">
                          <label className="block text-sm font-medium">Bonus/Malus libre</label>
                          <input type="number" name={"custom-" + i} className="border p-2 rounded w-full" placeholder="ex: 50 ou -20" inputMode="numeric" />
                          <p className="text-[11px] text-gray-600 mt-1">Pour g√©rer d'autres cas (Skull King, Sir√®ne, etc.).</p>
                        </div>
                      </div>
                    ))}
                  </div>

                  <div className="flex items-center gap-3 mt-3">
                    <button type="submit" className="bg-green-600 text-white px-4 py-2 rounded">
                      Valider la manche
                    </button>
                    <span className="text-sm text-gray-600">Les points de base + pirates + bonus libre seront additionn√©s.</span>
                  </div>
                </form>
              ) : (
                <div className="p-4 bg-emerald-50 border rounded">Partie termin√©e ! üéâ</div>
              )}
            </>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("app"));
    root.render(<SkullKingScoreApp />);
  </script>

  <script>
    // PWA: register service worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js");
      });
    }
  </script>
</body>
</html>
